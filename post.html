<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Post | The Unfiltered Trail</title>
    <meta name="description" id="pageDescription" content="Travel blog post from The Unfiltered Trail">
    <meta name="keywords" content="travel blog, Asia travel, Seoul, Saigon, backpacker guide, Korea, Vietnam">
    <meta name="author" content="Trail Explorer">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" id="ogTitle" content="Post | The Unfiltered Trail">
    <meta property="og:description" id="ogDescription" content="Travel blog post from The Unfiltered Trail">
    <meta property="og:image" id="ogImage" content="images/Whisk_a35f7a9c81.jpg">
    <meta property="og:url" content="https://theunfilteredtrail.com">
    <meta property="og:type" content="article">
    
    <!-- Twitter Card Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" id="twitterTitle" content="Post | The Unfiltered Trail">
    <meta name="twitter:description" id="twitterDescription" content="Travel blog post from The Unfiltered Trail">
    <meta name="twitter:image" id="twitterImage" content="images/Whisk_a35f7a9c81.jpg">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Stylesheet -->
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Prism.js for code highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    
    <!-- Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
    <header>
        <nav class="container">
            <a href="index.html" class="logo">The Unfiltered Trail</a>
            <div class="mobile-menu-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="index.html#posts">Posts</a></li>
                <li><a href="index.html#categories">Categories</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="index.html#contact">Contact</a></li>
                <li><a href="admin/" class="admin-link">Admin</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <!-- Loading State -->
        <div id="loadingState" class="container" style="text-align: center; padding: 4rem 2rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">‚è≥</div>
            <h2 style="color: var(--primary); margin-bottom: 1rem; font-family: 'Playfair Display', serif;">Loading Post...</h2>
            <p style="color: var(--light);">Fetching post content from GitHub...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="container" style="text-align: center; padding: 4rem 2rem; display: none;">
            <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">‚ùå</div>
            <h2 style="color: var(--primary); margin-bottom: 1rem; font-family: 'Playfair Display', serif;">Post Not Found</h2>
            <p style="color: var(--light); margin-bottom: 2rem;">Sorry, we couldn't find the post you're looking for.</p>
            <a href="index.html" class="btn btn-primary">‚Üê Back to Home</a>
        </div>

        <!-- Post Content -->
        <article id="postContent" class="container" style="display: none;">
            <!-- Back Navigation -->
            <div style="margin-bottom: 1rem;">
                <a href="index.html" class="btn btn-secondary" style="text-decoration: none;">
                    ‚Üê Back to Posts
                </a>
            </div>

            <!-- Featured Image -->
            <div id="featuredImageContainer" class="post-featured-image" style="margin-bottom: 2rem; border-radius: 16px; overflow: hidden; box-shadow: 0 8px 30px rgba(30, 58, 95, 0.1);">
                <img id="featuredImage" alt="" style="width: 100%; height: 300px; object-fit: cover;">
            </div>

            <!-- Post Body (with inline title) -->
            <div id="postBody" class="post-content" style="
                max-width: 800px; 
                margin: 0 auto; 
                font-size: 1.1rem; 
                line-height: 1.8; 
                color: var(--text);
            ">
                <!-- Post title, meta, and content will be inserted here -->
            </div>

            <!-- Share Buttons -->
            <div class="post-share" style="margin: 3rem 0; text-align: center; padding: 2rem; background: var(--light-bg); border-radius: 16px;">
                <h3 style="margin-bottom: 1rem; color: var(--primary);">Share this post</h3>
                <div class="share-buttons">
                    <button id="shareTwitter" class="btn btn-secondary" style="margin: 0.5rem;">Share on Twitter</button>
                    <button id="shareFacebook" class="btn btn-secondary" style="margin: 0.5rem;">Share on Facebook</button>
                    <button id="copyLink" class="btn btn-secondary" style="margin: 0.5rem;">Copy Link</button>
                </div>
            </div>

            <!-- Navigation to other posts -->
            <div class="post-navigation" style="margin: 3rem 0; text-align: center;">
                <a href="index.html#posts" class="btn btn-primary">‚Üê View All Posts</a>
            </div>
        </article>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>The Unfiltered Trail</h4>
                    <p>Real travel guides for Seoul and Saigon adventures. No fluff, just the good stuff.</p>
                    <div class="social-links">
                        <a href="#" aria-label="Instagram">üì∑</a>
                        <a href="#" aria-label="Twitter">üê¶</a>
                        <a href="#" aria-label="Facebook">üìò</a>
                    </div>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul style="list-style: none;">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="about.html">About</a></li>
                        <li><a href="index.html#categories">Categories</a></li>
                        <li><a href="index.html#contact">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Legal</h4>
                    <ul style="list-style: none;">
                        <li><a href="privacy.html">Privacy Policy</a></li>
                        <li><a href="terms.html">Terms of Service</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 The Unfiltered Trail. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Prism.js for code highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <!-- Post Loading Script -->
    <script>
        class IndividualPostLoader {
            constructor() {
                this.githubRepo = 'manulkkase/theunfilteredtrail';
                this.postsPath = '_posts';
            }

            // Get slug from URL parameters
            getSlugFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('slug');
            }

            // Fetch individual post content
            async fetchPost(slug) {
                try {
                    // Find the post file by slug
                    const response = await fetch(`https://api.github.com/repos/${this.githubRepo}/contents/${this.postsPath}`);
                    const files = await response.json();
                    
                    if (!Array.isArray(files)) return null;
                    
                    const postFile = files.find(file => 
                        file.name.endsWith('.md') && file.name.includes(slug)
                    );
                    
                    if (!postFile) return null;

                    // Fetch the actual post content
                    const contentResponse = await fetch(`https://raw.githubusercontent.com/${this.githubRepo}/main/${this.postsPath}/${postFile.name}`);
                    const content = await contentResponse.text();
                    
                    return this.parseMarkdown(content, postFile.name);
                } catch (error) {
                    console.error('Error fetching post:', error);
                    return null;
                }
            }

            // Parse markdown content
            parseMarkdown(content, filename) {
                const lines = content.split('\n');
                const post = {
                    filename: filename,
                    frontmatter: {},
                    body: ''
                };

                let inFrontmatter = false;
                let frontmatterEnd = 0;

                // Parse frontmatter
                if (lines[0] === '---') {
                    inFrontmatter = true;
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i] === '---') {
                            frontmatterEnd = i;
                            break;
                        }
                        const line = lines[i];
                        const colonIndex = line.indexOf(':');
                        if (colonIndex > -1) {
                            const key = line.substring(0, colonIndex).trim();
                            const value = line.substring(colonIndex + 1).trim();
                            post.frontmatter[key] = value.replace(/^["']|["']$/g, '');
                        }
                    }
                }

                // Parse body content
                post.body = lines.slice(frontmatterEnd + 1).join('\n').trim();

                // Extract date and slug from filename
                const match = filename.match(/^(\d{4}-\d{2}-\d{2})-(.+)\.md$/);
                if (match) {
                    post.date = match[1];
                    post.slug = match[2];
                }

                return post;
            }

            // Convert markdown to HTML (basic conversion)
            markdownToHtml(markdown) {
                return markdown
                    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                    .replace(/^\> (.*$)/gim, '<blockquote>$1</blockquote>')
                    .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                    .replace(/\*(.*)\*/gim, '<em>$1</em>')
                    .replace(/!\[([^\]]*)\]\(([^\)]*)\)/gim, '<img alt="$1" src="$2" style="max-width: 100%; height: auto; border-radius: 8px; margin: 1rem 0;">')
                    .replace(/\[([^\]]*)\]\(([^\)]*)\)/gim, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
                    .replace(/\n\n/gim, '</p><p>')
                    .replace(/^(.+$)/gim, '<p>$1</p>')
                    .replace(/<p><\/p>/gim, '');
            }

            // Render the post
            renderPost(post) {
                if (!post) {
                    this.showError();
                    return;
                }

                // Update page title and meta tags
                const title = `${post.frontmatter.title || 'Post'} | The Unfiltered Trail`;
                document.title = title;
                document.getElementById('pageTitle').textContent = title;
                document.getElementById('pageDescription').content = post.body.substring(0, 160) + '...';
                document.getElementById('ogTitle').content = title;
                document.getElementById('ogDescription').content = post.body.substring(0, 160) + '...';
                document.getElementById('twitterTitle').content = title;
                document.getElementById('twitterDescription').content = post.body.substring(0, 160) + '...';

                // Set featured image
                const featuredImage = post.frontmatter.featured_image || '/images/Whisk_a35f7a9c81.jpg';
                const processedImageSrc = featuredImage.startsWith('/assets/') 
                    ? featuredImage.replace('/assets/', '/') 
                    : featuredImage;
                
                document.getElementById('featuredImage').src = processedImageSrc;
                document.getElementById('featuredImage').alt = post.frontmatter.title || 'Post image';
                document.getElementById('ogImage').content = processedImageSrc;
                document.getElementById('twitterImage').content = processedImageSrc;

                // Format date
                const formattedDate = new Date(post.frontmatter.date || post.date).toLocaleDateString('en-AU', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                // Get category
                const category = post.frontmatter.category || 'Uncategorized';

                // Create post header HTML
                const postHeaderHTML = `
                    <div style="margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border);">
                        <div style="margin-bottom: 1rem;">
                            <a href="category.html?category=${encodeURIComponent(category)}" class="card-category" style="text-decoration: none;">${category}</a>
                            <span style="color: var(--light); margin-left: 1rem;">${formattedDate}</span>
                        </div>
                        <h1 style="font-family: 'Playfair Display', serif; font-size: 2.5rem; color: var(--primary); margin-bottom: 0.5rem; line-height: 1.2;">${post.frontmatter.title || 'Untitled'}</h1>
                        <div style="color: var(--light); font-size: 0.9rem;">
                            <span>üë§ Trail Explorer</span>
                        </div>
                    </div>
                `;

                // Convert markdown to HTML and combine with header
                const htmlContent = this.markdownToHtml(post.body);
                document.getElementById('postBody').innerHTML = postHeaderHTML + htmlContent;

                // Setup share buttons
                this.setupShareButtons(post);

                // Show the post content
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('postContent').style.display = 'block';
            }

            // Setup share buttons
            setupShareButtons(post) {
                const url = window.location.href;
                const title = post.frontmatter.title || 'Check out this post';
                
                document.getElementById('shareTwitter').onclick = () => {
                    window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`, '_blank');
                };
                
                document.getElementById('shareFacebook').onclick = () => {
                    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
                };
                
                document.getElementById('copyLink').onclick = () => {
                    navigator.clipboard.writeText(url).then(() => {
                        alert('Link copied to clipboard!');
                    });
                };
            }

            // Show error state
            showError() {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
            }

            // Load and display post
            async loadPost() {
                const slug = this.getSlugFromURL();
                if (!slug) {
                    this.showError();
                    return;
                }

                console.log('Loading post with slug:', slug);
                const post = await this.fetchPost(slug);
                this.renderPost(post);
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const loader = new IndividualPostLoader();
            loader.loadPost();
        });

        // Netlify Identity Widget
        if (window.netlifyIdentity) {
            window.netlifyIdentity.on("init", user => {
                if (!user) {
                    window.netlifyIdentity.on("login", () => {
                        document.location.href = "/admin/";
                    });
                }
            });
        }
    </script>
</body>
</html>